version: "3.9"

x-django-env: &django-common-env
  POSTGRES_HOST: postgres
  POSTGRES_PORT: "5432"
  POSTGRES_USER: postgres
  POSTGRES_PASSWORD: postgres
  DJANGO_SETTINGS_MODULE: ""     # optional, set per service if you use non-default
  PYTHONDONTWRITEBYTECODE: "1"
  PYTHONUNBUFFERED: "1"
  # For Kafka inside containers use kafka:9092 (don't use localhost:9092)
  KAFKA_BOOTSTRAP_SERVERS: kafka:9092

services:
  # ---------- DATA LAYER ----------
  postgres:
    image: postgres:15
    container_name: pg-main
    restart: unless-stopped
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    volumes:
      - pgdata:/var/lib/postgresql/data
      - ./postgres/init-db.sql:/docker-entrypoint-initdb.d/init-db.sql:ro
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 10

  # Single-node Kafka (KRaft mode) suitable for local/dev & small setups
  kafka:
    image: bitnami/kafka:3.7
    container_name: kafka-broker
    restart: unless-stopped
    environment:
      KAFKA_ENABLE_KRAFT: "yes"
      KAFKA_CFG_NODE_ID: "1"
      KAFKA_CFG_PROCESS_ROLES: "broker"
      KAFKA_CFG_LISTENERS: PLAINTEXT://:9092,CONTROLLER://:9093
      KAFKA_CFG_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092
      KAFKA_CFG_CONTROLLER_LISTENER_NAMES: CONTROLLER
      KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP: CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT
      KAFKA_CFG_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_CFG_CONTROLLER_QUORUM_VOTERS: "1@kafka:9093"
    ports:
      - "9092:9092"  # lets your host tools connect if needed
    healthcheck:
      test: ["CMD-SHELL", "kafka-topics.sh --bootstrap-server kafka:9092 --list >/dev/null 2>&1"]
      interval: 10s
      timeout: 5s
      retries: 20

  # ---------- KONG API GATEWAY ----------
  kong-db:
    image: postgres:15
    container_name: kong-db
    restart: unless-stopped
    environment:
      POSTGRES_USER: kong
      POSTGRES_PASSWORD: kong
      POSTGRES_DB: kong
    volumes:
      - kongdb:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U kong"]
      interval: 5s
      timeout: 5s
      retries: 10

  kong-migrations:
    image: kong/kong-gateway:3.8
    restart: on-failure
    environment:
      KONG_DATABASE: postgres
      KONG_PG_HOST: kong-db
      KONG_PG_USER: kong
      KONG_PG_PASSWORD: kong
    depends_on:
      kong-db:
        condition: service_healthy
    command: ["/bin/sh", "-lc", "kong migrations bootstrap || kong migrations up"]

  kong:
    image: kong/kong-gateway:3.8
    container_name: kong
    restart: unless-stopped
    environment:
      KONG_DATABASE: postgres
      KONG_PG_HOST: kong-db
      KONG_PG_USER: kong
      KONG_PG_PASSWORD: kong
      KONG_PROXY_LISTEN: "0.0.0.0:8000"
      KONG_ADMIN_LISTEN: "0.0.0.0:8001"
      KONG_LOG_LEVEL: notice
    ports:
      - "8000:8000"   # Public API
      - "8001:8001"   # Admin API
    depends_on:
      kong-migrations:
        condition: service_completed_successfully

  konga:
    image: pantsel/konga:latest
    container_name: konga
    restart: unless-stopped
    environment:
      DB_ADAPTER: postgres
      DB_HOST: kong-db
      DB_PORT: 5432
      DB_USER: kong
      DB_PASSWORD: kong
      DB_DATABASE: kong
      NODE_ENV: production
    ports:
      - "1337:1337"
    depends_on:
      - kong
      - kong-db

  # One-shot bootstrap to register services/routes/plugins in Kong automatically
  kong-init:
    image: curlimages/curl:8.9.1
    depends_on:
      kong:
        condition: service_started
      auth_service:
        condition: service_started
      service_provider_service:
        condition: service_started
      super_admin_service:
        condition: service_started
    entrypoint: ["/bin/sh", "/init/kong-init.sh"]
    volumes:
      - ./kong/kong-init.sh:/init/kong-init.sh:ro

  # ---------- DJANGO SERVICES (Gunicorn) ----------
  auth_service:
    build: ./Auth_Serivce  # (keep your folder name)
    container_name: auth_service
    restart: unless-stopped
    environment:
      <<: *django-common-env
      POSTGRES_DB: Auth_Service
      DJANGO_SETTINGS_MODULE: auth_service.settings
      # Anything else your settings read from env
    command: >
      sh -c "python manage.py migrate &&
             gunicorn auth_service.wsgi:application --bind 0.0.0.0:8000 --workers 3"
    ports:
      - "8000:8000"   # optional: expose if you want to hit it directly
    depends_on:
      postgres:
        condition: service_healthy
      kafka:
        condition: service_started

  service_provider_service:
    build: ./service_provider_service
    container_name: service_provider_service
    restart: unless-stopped
    environment:
      <<: *django-common-env
      POSTGRES_DB: Service_Provider
      DJANGO_SETTINGS_MODULE: service_provider_service.settings
    command: >
      sh -c "python manage.py migrate &&
             gunicorn service_provider_service.wsgi:application --bind 0.0.0.0:8002 --workers 3"
    ports:
      - "8002:8002"
    depends_on:
      postgres:
        condition: service_healthy
      kafka:
        condition: service_started

  super_admin_service:
    build: ./super_admin_service
    container_name: super_admin_service
    restart: unless-stopped
    environment:
      <<: *django-common-env
      POSTGRES_DB: Super_Admin
      DJANGO_SETTINGS_MODULE: super_admin_service.settings
    command: >
      sh -c "python manage.py migrate &&
             gunicorn super_admin_service.wsgi:application --bind 0.0.0.0:8003 --workers 3"
    ports:
      - "8003:8003"
    depends_on:
      postgres:
        condition: service_healthy
      kafka:
        condition: service_started

volumes:
  pgdata:
  kongdb:
